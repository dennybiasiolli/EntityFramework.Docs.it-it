---
title: Rilevamento e query senza rilevamento - Entity Framework CoreTracking vs.
author: smitpatel
ms.date: 10/10/2019
ms.assetid: e17e060c-929f-4180-8883-40c438fbcc01
uid: core/querying/tracking
ms.openlocfilehash: a6c71c12f429f1324abe91d1b2cef96312bec051
ms.sourcegitcommit: 9b562663679854c37c05fca13d93e180213fb4aa
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 04/07/2020
ms.locfileid: "78417649"
---
# <a name="tracking-vs-no-tracking-queries"></a><span data-ttu-id="15ccc-102">Rilevamento e query senza rilevamentoTracking vs.</span><span class="sxs-lookup"><span data-stu-id="15ccc-102">Tracking vs. No-Tracking Queries</span></span>

<span data-ttu-id="15ccc-103">Controlli del comportamento di rilevamento se Entity Framework Core manterrà le informazioni su un'istanza di entità nel rilevamento delle modifiche.</span><span class="sxs-lookup"><span data-stu-id="15ccc-103">Tracking behavior controls if Entity Framework Core will keep information about an entity instance in its change tracker.</span></span> <span data-ttu-id="15ccc-104">Se un'entità viene inclusa nel rilevamento delle modifiche, qualsiasi modifica individuata per l'entità verrà salvata in modo permanente nel database durante `SaveChanges()`.</span><span class="sxs-lookup"><span data-stu-id="15ccc-104">If an entity is tracked, any changes detected in the entity will be persisted to the database during `SaveChanges()`.</span></span> <span data-ttu-id="15ccc-105">EF Core correggerà anche le proprietà di navigazione tra le entità nel risultato di una query di rilevamento e le entità che si trovano nel rilevamento delle modifiche.</span><span class="sxs-lookup"><span data-stu-id="15ccc-105">EF Core will also fix up navigation properties between the entities in a tracking query result and the entities that are in the change tracker.</span></span>

> [!NOTE]
> <span data-ttu-id="15ccc-106">[I tipi di entità senza chiave](xref:core/modeling/keyless-entity-types) non vengono mai rilevati.</span><span class="sxs-lookup"><span data-stu-id="15ccc-106">[Keyless entity types](xref:core/modeling/keyless-entity-types) are never tracked.</span></span> <span data-ttu-id="15ccc-107">Ovunque in questo articolo vengano menzionati i tipi di entità, si riferisce ai tipi di entità per i quali è stata definita una chiave.</span><span class="sxs-lookup"><span data-stu-id="15ccc-107">Wherever this article mentions entity types, it refers to entity types which have a key defined.</span></span>

> [!TIP]  
> <span data-ttu-id="15ccc-108">È possibile visualizzare l'[esempio](https://github.com/dotnet/EntityFramework.Docs/tree/master/samples/core/Querying) di questo articolo in GitHub.</span><span class="sxs-lookup"><span data-stu-id="15ccc-108">You can view this article's [sample](https://github.com/dotnet/EntityFramework.Docs/tree/master/samples/core/Querying) on GitHub.</span></span>

## <a name="tracking-queries"></a><span data-ttu-id="15ccc-109">Query con rilevamento delle modifiche</span><span class="sxs-lookup"><span data-stu-id="15ccc-109">Tracking queries</span></span>

<span data-ttu-id="15ccc-110">Per impostazione predefinita, le query che restituiscono tipi di entità sono con rilevamento delle modifiche.</span><span class="sxs-lookup"><span data-stu-id="15ccc-110">By default, queries that return entity types are tracking.</span></span> <span data-ttu-id="15ccc-111">Ciò significa che è possibile apportare modifiche a `SaveChanges()`tali istanze di entità e rendere persistenti tali modifiche da .</span><span class="sxs-lookup"><span data-stu-id="15ccc-111">Which means you can make changes to those entity instances and have those changes persisted by `SaveChanges()`.</span></span> <span data-ttu-id="15ccc-112">Nell'esempio seguente la modifica della classificazione del blog verrà rilevata e salvata in modo permanente nel database durante `SaveChanges()`.</span><span class="sxs-lookup"><span data-stu-id="15ccc-112">In the following example, the change to the blogs rating will be detected and persisted to the database during `SaveChanges()`.</span></span>

[!code-csharp[Main](../../../samples/core/Querying/Tracking/Sample.cs#Tracking)]

## <a name="no-tracking-queries"></a><span data-ttu-id="15ccc-113">Query senza registrazione</span><span class="sxs-lookup"><span data-stu-id="15ccc-113">No-tracking queries</span></span>

<span data-ttu-id="15ccc-114">Le query senza rilevamento delle modifiche sono utili quando i risultati vengono usati in uno scenario di sola lettura.</span><span class="sxs-lookup"><span data-stu-id="15ccc-114">No tracking queries are useful when the results are used in a read-only scenario.</span></span> <span data-ttu-id="15ccc-115">Sono più veloci da eseguire perché non è necessario impostare le informazioni sul rilevamento delle modifiche.</span><span class="sxs-lookup"><span data-stu-id="15ccc-115">They're quicker to execute because there's no need to set up the change tracking information.</span></span> <span data-ttu-id="15ccc-116">Se non è necessario aggiornare le entità recuperate dal database, è necessario utilizzare una query senza rilevamento.</span><span class="sxs-lookup"><span data-stu-id="15ccc-116">If you don't need to update the entities retrieved from the database, then a no-tracking query should be used.</span></span> <span data-ttu-id="15ccc-117">È possibile scambiare una singola query per non tenere traccia.</span><span class="sxs-lookup"><span data-stu-id="15ccc-117">You can swap an individual query to be no-tracking.</span></span>

[!code-csharp[Main](../../../samples/core/Querying/Tracking/Sample.cs#NoTracking)]

<span data-ttu-id="15ccc-118">È anche possibile modificare il comportamento predefinito di rilevamento delle modifiche a livello di istanza di contesto:</span><span class="sxs-lookup"><span data-stu-id="15ccc-118">You can also change the default tracking behavior at the context instance level:</span></span>

[!code-csharp[Main](../../../samples/core/Querying/Tracking/Sample.cs#ContextDefaultTrackingBehavior)]

## <a name="identity-resolution"></a><span data-ttu-id="15ccc-119">Risoluzione di identità</span><span class="sxs-lookup"><span data-stu-id="15ccc-119">Identity resolution</span></span>

<span data-ttu-id="15ccc-120">Poiché una query di rilevamento utilizza il rilevamento delle modifiche, EF Core eseguirà la risoluzione delle identità in una query di rilevamento.</span><span class="sxs-lookup"><span data-stu-id="15ccc-120">Since a tracking query uses the change tracker, EF Core will do identity resolution in a tracking query.</span></span> <span data-ttu-id="15ccc-121">Durante la materializzazione di un'entità, Entity Framework Core restituirà la stessa istanza di entità dal rilevamento delle modifiche se è già in fase di rilevamento.</span><span class="sxs-lookup"><span data-stu-id="15ccc-121">When materializing an entity, EF Core will return the same entity instance from the change tracker if it's already being tracked.</span></span> <span data-ttu-id="15ccc-122">Se il risultato contiene la stessa entità più volte, si ottiene la stessa istanza per ogni occorrenza.</span><span class="sxs-lookup"><span data-stu-id="15ccc-122">If the result contains same entity multiple times, you get back same instance for each occurrence.</span></span> <span data-ttu-id="15ccc-123">Le query senza monitoraggio non utilizzano il rilevamento delle modifiche e non eseguono la risoluzione delle identità.</span><span class="sxs-lookup"><span data-stu-id="15ccc-123">No-tracking queries don't use the change tracker and don't do identity resolution.</span></span> <span data-ttu-id="15ccc-124">In questo modo si ottiene una nuova istanza dell'entità anche quando la stessa entità è contenuta nel risultato più volte.</span><span class="sxs-lookup"><span data-stu-id="15ccc-124">So you get back new instance of entity even when the same entity is contained in the result multiple times.</span></span> <span data-ttu-id="15ccc-125">Questo comportamento era diverso nelle versioni precedenti a EF Core 3.0, vedere [le versioni precedenti.](#previous-versions)</span><span class="sxs-lookup"><span data-stu-id="15ccc-125">This behavior was different in versions before EF Core 3.0, see [previous versions](#previous-versions).</span></span>

## <a name="tracking-and-custom-projections"></a><span data-ttu-id="15ccc-126">Monitoraggio e proiezioni personalizzate</span><span class="sxs-lookup"><span data-stu-id="15ccc-126">Tracking and custom projections</span></span>

<span data-ttu-id="15ccc-127">Anche se il tipo di risultato della query non è un tipo di entità, Entity Framework Core continuerà a tenere traccia dei tipi di entità contenuti nel risultato per impostazione predefinita.</span><span class="sxs-lookup"><span data-stu-id="15ccc-127">Even if the result type of the query isn't an entity type, EF Core will still track entity types contained in the result by default.</span></span> <span data-ttu-id="15ccc-128">Nella query seguente, che restituisce un tipo anonimo, le istanze di `Blog` nel set di risultati verranno incluse nel rilevamento delle modifiche.</span><span class="sxs-lookup"><span data-stu-id="15ccc-128">In the following query, which returns an anonymous type, the instances of `Blog` in the result set will be tracked.</span></span>

[!code-csharp[Main](../../../samples/core/Querying/Tracking/Sample.cs#CustomProjection1)]

<span data-ttu-id="15ccc-129">Se il set di risultati contiene tipi di entità che escono dalla composizione LINQ, Entity Framework Core ne terrà traccia.</span><span class="sxs-lookup"><span data-stu-id="15ccc-129">If the result set contains entity types coming out from LINQ composition, EF Core will track them.</span></span>

[!code-csharp[Main](../../../samples/core/Querying/Tracking/Sample.cs#CustomProjection2)]

<span data-ttu-id="15ccc-130">Se il set di risultati non contiene tipi di entità, non viene eseguito alcun rilevamento.</span><span class="sxs-lookup"><span data-stu-id="15ccc-130">If the result set doesn't contain any entity types, then no tracking is done.</span></span> <span data-ttu-id="15ccc-131">Nella query seguente viene restituito un tipo anonimo con alcuni valori dell'entità (ma nessuna istanza del tipo di entità effettivo).</span><span class="sxs-lookup"><span data-stu-id="15ccc-131">In the following query, we return an anonymous type with some of the values from the entity (but no instances of the actual entity type).</span></span> <span data-ttu-id="15ccc-132">Non sono presenti entità rilevate che escono dalla query.</span><span class="sxs-lookup"><span data-stu-id="15ccc-132">There are no tracked entities coming out of the query.</span></span>

[!code-csharp[Main](../../../samples/core/Querying/Tracking/Sample.cs#CustomProjection3)]

 <span data-ttu-id="15ccc-133">EF Core supporta l'esecuzione della valutazione del client nella proiezione di primo livello.</span><span class="sxs-lookup"><span data-stu-id="15ccc-133">EF Core supports doing client evaluation in the top-level projection.</span></span> <span data-ttu-id="15ccc-134">Se Entity Framework Core materializza un'istanza di entità per la valutazione del client, verrà tenuta traccia di tale istanza.</span><span class="sxs-lookup"><span data-stu-id="15ccc-134">If EF Core materializes an entity instance for client evaluation, it will be tracked.</span></span> <span data-ttu-id="15ccc-135">Qui, dal momento `blog` che stiamo passando `StandardizeURL`entità al metodo client , EF Core terrà traccia anche le istanze del blog.</span><span class="sxs-lookup"><span data-stu-id="15ccc-135">Here, since we're passing `blog` entities to the client method `StandardizeURL`, EF Core will track the blog instances too.</span></span>

[!code-csharp[Main](../../../samples/core/Querying/Tracking/Sample.cs#ClientProjection)]

[!code-csharp[Main](../../../samples/core/Querying/Tracking/Sample.cs#ClientMethod)]

<span data-ttu-id="15ccc-136">EF Core non tiene traccia delle istanze di entità senza chiave contenute nel risultato.</span><span class="sxs-lookup"><span data-stu-id="15ccc-136">EF Core doesn't track the keyless entity instances contained in the result.</span></span> <span data-ttu-id="15ccc-137">Ma Entity Framework Core tiene traccia di tutte le altre istanze di tipi di entità con chiave in base alle regole precedenti.</span><span class="sxs-lookup"><span data-stu-id="15ccc-137">But EF Core tracks all the other instances of entity types with key according to rules above.</span></span>

<span data-ttu-id="15ccc-138">Alcune delle regole di cui sopra hanno funzionato in modo diverso prima di EF Core 3.0.</span><span class="sxs-lookup"><span data-stu-id="15ccc-138">Some of the above rules worked differently before EF Core 3.0.</span></span> <span data-ttu-id="15ccc-139">Per ulteriori informazioni, vedere [versioni precedenti](#previous-versions).</span><span class="sxs-lookup"><span data-stu-id="15ccc-139">For more information, see [previous versions](#previous-versions).</span></span>

## <a name="previous-versions"></a><span data-ttu-id="15ccc-140">Versioni precedenti</span><span class="sxs-lookup"><span data-stu-id="15ccc-140">Previous versions</span></span>

<span data-ttu-id="15ccc-141">Prima della versione 3.0, EF Core aveva alcune differenze nel modo in cui è stato eseguito il rilevamento.</span><span class="sxs-lookup"><span data-stu-id="15ccc-141">Before version 3.0, EF Core had some differences in how tracking was done.</span></span> <span data-ttu-id="15ccc-142">Differenze degne di nota sono le seguenti:</span><span class="sxs-lookup"><span data-stu-id="15ccc-142">Notable differences are as follows:</span></span>

- <span data-ttu-id="15ccc-143">Come spiegato nella pagina [Valutazione client e server,](xref:core/querying/client-eval) valutazione client supportata da EF Core in qualsiasi parte della query precedente alla versione 3.0.As explained in Client vs Server Evaluation page, EF Core supported client evaluation in any part of the query before version 3.0.</span><span class="sxs-lookup"><span data-stu-id="15ccc-143">As explained in [Client vs Server Evaluation](xref:core/querying/client-eval) page, EF Core supported client evaluation in any part of the query before version 3.0.</span></span> <span data-ttu-id="15ccc-144">La valutazione del client ha causato la materializzazione delle entità, che non facevano parte del risultato.</span><span class="sxs-lookup"><span data-stu-id="15ccc-144">Client evaluation caused materialization of entities, which weren't part of the result.</span></span> <span data-ttu-id="15ccc-145">Così EF Core analizzato il risultato per rilevare cosa tenere traccia. Questo progetto ha avuto alcune differenze come segue:</span><span class="sxs-lookup"><span data-stu-id="15ccc-145">So EF Core analyzed the result to detect what to track. This design had certain differences as follows:</span></span>
  - <span data-ttu-id="15ccc-146">La valutazione del client nella proiezione, che ha causato la materializzazione ma non ha restituito l'istanza dell'entità materializzata non è stata rilevata.</span><span class="sxs-lookup"><span data-stu-id="15ccc-146">Client evaluation in the projection, which caused materialization but didn't return the materialized entity instance wasn't tracked.</span></span> <span data-ttu-id="15ccc-147">L'esempio seguente non `blog` tiene traccia delle entità.</span><span class="sxs-lookup"><span data-stu-id="15ccc-147">The following example didn't track `blog` entities.</span></span>
    [!code-csharp[Main](../../../samples/core/Querying/Tracking/Sample.cs#ClientProjection)]

  - <span data-ttu-id="15ccc-148">EF Core non tiene traccia degli oggetti che escono dalla composizione LINQ in alcuni casi.</span><span class="sxs-lookup"><span data-stu-id="15ccc-148">EF Core didn't track the objects coming out of LINQ composition in certain cases.</span></span> <span data-ttu-id="15ccc-149">Nell'esempio seguente non `Post`è stato tracciato .</span><span class="sxs-lookup"><span data-stu-id="15ccc-149">The following example didn't track `Post`.</span></span>
    [!code-csharp[Main](../../../samples/core/Querying/Tracking/Sample.cs#CustomProjection2)]

- <span data-ttu-id="15ccc-150">Ogni volta che i risultati della query contenevano tipi di entità senza chiave, l'intera query è stata resa senza rilevamento.</span><span class="sxs-lookup"><span data-stu-id="15ccc-150">Whenever query results contained keyless entity types, the whole query was made non-tracking.</span></span> <span data-ttu-id="15ccc-151">Ciò significa che i tipi di entità con chiavi, che sono in risultato non sono stati registrati neanche.</span><span class="sxs-lookup"><span data-stu-id="15ccc-151">That means that entity types with keys, which are in result weren't being tracked either.</span></span>
- <span data-ttu-id="15ccc-152">EF Core ha esito la risoluzione delle identità in query senza rilevamento.</span><span class="sxs-lookup"><span data-stu-id="15ccc-152">EF Core did identity resolution in no-tracking query.</span></span> <span data-ttu-id="15ccc-153">Utilizzava riferimenti deboli per tenere traccia delle entità che erano già state restituite.</span><span class="sxs-lookup"><span data-stu-id="15ccc-153">It used weak references to keep track of entities that had already been returned.</span></span> <span data-ttu-id="15ccc-154">Pertanto, se un set di risultati contiene la stessa entità più volte, si otterrebbe la stessa istanza per ogni occorrenza.</span><span class="sxs-lookup"><span data-stu-id="15ccc-154">So if a result set contained the same entity multiples times, you would get the same instance for each occurrence.</span></span> <span data-ttu-id="15ccc-155">Anche se un risultato precedente con la stessa identità è uscito dall'ambito e ottenuto garbage collection, EF Core restituito una nuova istanza.</span><span class="sxs-lookup"><span data-stu-id="15ccc-155">Though if a previous result with the same identity went out of scope and got garbage collected, EF Core returned a new instance.</span></span>
