---
title: Rilevamento e query senza rilevamento-EF Core
author: smitpatel
ms.date: 10/10/2019
ms.assetid: e17e060c-929f-4180-8883-40c438fbcc01
uid: core/querying/tracking
ms.openlocfilehash: a6c71c12f429f1324abe91d1b2cef96312bec051
ms.sourcegitcommit: cc0ff36e46e9ed3527638f7208000e8521faef2e
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 03/06/2020
ms.locfileid: "78417649"
---
# <a name="tracking-vs-no-tracking-queries"></a><span data-ttu-id="7e0d8-102">Rilevamento e query senza rilevamento</span><span class="sxs-lookup"><span data-stu-id="7e0d8-102">Tracking vs. No-Tracking Queries</span></span>

<span data-ttu-id="7e0d8-103">Il rilevamento del comportamento Controlla se Entity Framework Core manterrà le informazioni su un'istanza di entità nel relativo strumento di rilevamento delle modifiche.</span><span class="sxs-lookup"><span data-stu-id="7e0d8-103">Tracking behavior controls if Entity Framework Core will keep information about an entity instance in its change tracker.</span></span> <span data-ttu-id="7e0d8-104">Se un'entità viene inclusa nel rilevamento delle modifiche, qualsiasi modifica individuata per l'entità verrà salvata in modo permanente nel database durante `SaveChanges()`.</span><span class="sxs-lookup"><span data-stu-id="7e0d8-104">If an entity is tracked, any changes detected in the entity will be persisted to the database during `SaveChanges()`.</span></span> <span data-ttu-id="7e0d8-105">EF Core correggerà anche le proprietà di navigazione tra le entità in un risultato della query di rilevamento e le entità presenti nello strumento di rilevamento delle modifiche.</span><span class="sxs-lookup"><span data-stu-id="7e0d8-105">EF Core will also fix up navigation properties between the entities in a tracking query result and the entities that are in the change tracker.</span></span>

> [!NOTE]
> <span data-ttu-id="7e0d8-106">I [tipi di entità senza chiave](xref:core/modeling/keyless-entity-types) non vengono mai rilevati.</span><span class="sxs-lookup"><span data-stu-id="7e0d8-106">[Keyless entity types](xref:core/modeling/keyless-entity-types) are never tracked.</span></span> <span data-ttu-id="7e0d8-107">Quando in questo articolo vengono citati i tipi di entità, si riferisce ai tipi di entità con una chiave definita.</span><span class="sxs-lookup"><span data-stu-id="7e0d8-107">Wherever this article mentions entity types, it refers to entity types which have a key defined.</span></span>

> [!TIP]  
> <span data-ttu-id="7e0d8-108">È possibile visualizzare l'[esempio](https://github.com/dotnet/EntityFramework.Docs/tree/master/samples/core/Querying) di questo articolo in GitHub.</span><span class="sxs-lookup"><span data-stu-id="7e0d8-108">You can view this article's [sample](https://github.com/dotnet/EntityFramework.Docs/tree/master/samples/core/Querying) on GitHub.</span></span>

## <a name="tracking-queries"></a><span data-ttu-id="7e0d8-109">Query con rilevamento delle modifiche</span><span class="sxs-lookup"><span data-stu-id="7e0d8-109">Tracking queries</span></span>

<span data-ttu-id="7e0d8-110">Per impostazione predefinita, le query che restituiscono tipi di entità sono con rilevamento delle modifiche.</span><span class="sxs-lookup"><span data-stu-id="7e0d8-110">By default, queries that return entity types are tracking.</span></span> <span data-ttu-id="7e0d8-111">Ciò significa che è possibile apportare modifiche a tali istanze di entità e rendere le modifiche rese permanente da `SaveChanges()`.</span><span class="sxs-lookup"><span data-stu-id="7e0d8-111">Which means you can make changes to those entity instances and have those changes persisted by `SaveChanges()`.</span></span> <span data-ttu-id="7e0d8-112">Nell'esempio seguente la modifica della classificazione del blog verrà rilevata e salvata in modo permanente nel database durante `SaveChanges()`.</span><span class="sxs-lookup"><span data-stu-id="7e0d8-112">In the following example, the change to the blogs rating will be detected and persisted to the database during `SaveChanges()`.</span></span>

[!code-csharp[Main](../../../samples/core/Querying/Tracking/Sample.cs#Tracking)]

## <a name="no-tracking-queries"></a><span data-ttu-id="7e0d8-113">Query senza registrazione</span><span class="sxs-lookup"><span data-stu-id="7e0d8-113">No-tracking queries</span></span>

<span data-ttu-id="7e0d8-114">Le query senza rilevamento delle modifiche sono utili quando i risultati vengono usati in uno scenario di sola lettura.</span><span class="sxs-lookup"><span data-stu-id="7e0d8-114">No tracking queries are useful when the results are used in a read-only scenario.</span></span> <span data-ttu-id="7e0d8-115">Sono più veloci da eseguire perché non è necessario impostare le informazioni sul rilevamento delle modifiche.</span><span class="sxs-lookup"><span data-stu-id="7e0d8-115">They're quicker to execute because there's no need to set up the change tracking information.</span></span> <span data-ttu-id="7e0d8-116">Se non è necessario aggiornare le entità recuperate dal database, è necessario utilizzare una query senza rilevamento.</span><span class="sxs-lookup"><span data-stu-id="7e0d8-116">If you don't need to update the entities retrieved from the database, then a no-tracking query should be used.</span></span> <span data-ttu-id="7e0d8-117">È possibile scambiare una singola query senza tracciare.</span><span class="sxs-lookup"><span data-stu-id="7e0d8-117">You can swap an individual query to be no-tracking.</span></span>

[!code-csharp[Main](../../../samples/core/Querying/Tracking/Sample.cs#NoTracking)]

<span data-ttu-id="7e0d8-118">È anche possibile modificare il comportamento predefinito di rilevamento delle modifiche a livello di istanza di contesto:</span><span class="sxs-lookup"><span data-stu-id="7e0d8-118">You can also change the default tracking behavior at the context instance level:</span></span>

[!code-csharp[Main](../../../samples/core/Querying/Tracking/Sample.cs#ContextDefaultTrackingBehavior)]

## <a name="identity-resolution"></a><span data-ttu-id="7e0d8-119">Risoluzione di identità</span><span class="sxs-lookup"><span data-stu-id="7e0d8-119">Identity resolution</span></span>

<span data-ttu-id="7e0d8-120">Poiché una query di rilevamento USA change tracker, EF Core eseguirà la risoluzione delle identità in una query di rilevamento.</span><span class="sxs-lookup"><span data-stu-id="7e0d8-120">Since a tracking query uses the change tracker, EF Core will do identity resolution in a tracking query.</span></span> <span data-ttu-id="7e0d8-121">Quando si materializzazione un'entità, EF Core restituirà la stessa istanza dell'entità dallo strumento di rilevamento delle modifiche, se è già stata rilevata.</span><span class="sxs-lookup"><span data-stu-id="7e0d8-121">When materializing an entity, EF Core will return the same entity instance from the change tracker if it's already being tracked.</span></span> <span data-ttu-id="7e0d8-122">Se il risultato contiene la stessa entità più volte, viene restituita la stessa istanza per ogni occorrenza.</span><span class="sxs-lookup"><span data-stu-id="7e0d8-122">If the result contains same entity multiple times, you get back same instance for each occurrence.</span></span> <span data-ttu-id="7e0d8-123">Le query senza rilevamento non usano change tracker e non eseguono la risoluzione delle identità.</span><span class="sxs-lookup"><span data-stu-id="7e0d8-123">No-tracking queries don't use the change tracker and don't do identity resolution.</span></span> <span data-ttu-id="7e0d8-124">Quindi, si ottiene una nuova istanza dell'entità anche quando la stessa entità è contenuta nel risultato più volte.</span><span class="sxs-lookup"><span data-stu-id="7e0d8-124">So you get back new instance of entity even when the same entity is contained in the result multiple times.</span></span> <span data-ttu-id="7e0d8-125">Questo comportamento è diverso nelle versioni precedenti EF Core 3,0, vedere [versioni precedenti](#previous-versions).</span><span class="sxs-lookup"><span data-stu-id="7e0d8-125">This behavior was different in versions before EF Core 3.0, see [previous versions](#previous-versions).</span></span>

## <a name="tracking-and-custom-projections"></a><span data-ttu-id="7e0d8-126">Rilevamento e proiezioni personalizzate</span><span class="sxs-lookup"><span data-stu-id="7e0d8-126">Tracking and custom projections</span></span>

<span data-ttu-id="7e0d8-127">Anche se il tipo di risultato della query non è un tipo di entità, EF Core continuerà a tenere traccia dei tipi di entità contenuti nel risultato per impostazione predefinita.</span><span class="sxs-lookup"><span data-stu-id="7e0d8-127">Even if the result type of the query isn't an entity type, EF Core will still track entity types contained in the result by default.</span></span> <span data-ttu-id="7e0d8-128">Nella query seguente, che restituisce un tipo anonimo, le istanze di `Blog` nel set di risultati verranno incluse nel rilevamento delle modifiche.</span><span class="sxs-lookup"><span data-stu-id="7e0d8-128">In the following query, which returns an anonymous type, the instances of `Blog` in the result set will be tracked.</span></span>

[!code-csharp[Main](../../../samples/core/Querying/Tracking/Sample.cs#CustomProjection1)]

<span data-ttu-id="7e0d8-129">Se il set di risultati contiene tipi di entità provenienti dalla composizione LINQ, EF Core li terrà traccia.</span><span class="sxs-lookup"><span data-stu-id="7e0d8-129">If the result set contains entity types coming out from LINQ composition, EF Core will track them.</span></span>

[!code-csharp[Main](../../../samples/core/Querying/Tracking/Sample.cs#CustomProjection2)]

<span data-ttu-id="7e0d8-130">Se il set di risultati non contiene tipi di entità, non viene eseguita alcuna verifica.</span><span class="sxs-lookup"><span data-stu-id="7e0d8-130">If the result set doesn't contain any entity types, then no tracking is done.</span></span> <span data-ttu-id="7e0d8-131">Nella query seguente viene restituito un tipo anonimo con alcuni valori dell'entità, ma nessuna istanza del tipo di entità effettivo.</span><span class="sxs-lookup"><span data-stu-id="7e0d8-131">In the following query, we return an anonymous type with some of the values from the entity (but no instances of the actual entity type).</span></span> <span data-ttu-id="7e0d8-132">Nessuna entità rilevata esce dalla query.</span><span class="sxs-lookup"><span data-stu-id="7e0d8-132">There are no tracked entities coming out of the query.</span></span>

[!code-csharp[Main](../../../samples/core/Querying/Tracking/Sample.cs#CustomProjection3)]

 <span data-ttu-id="7e0d8-133">EF Core supporta la valutazione dei client nella proiezione di primo livello.</span><span class="sxs-lookup"><span data-stu-id="7e0d8-133">EF Core supports doing client evaluation in the top-level projection.</span></span> <span data-ttu-id="7e0d8-134">Se EF Core materializza un'istanza di entità per la valutazione client, verrà rilevata.</span><span class="sxs-lookup"><span data-stu-id="7e0d8-134">If EF Core materializes an entity instance for client evaluation, it will be tracked.</span></span> <span data-ttu-id="7e0d8-135">Qui, poiché stiamo passando `blog` entità al metodo client `StandardizeURL`, EF Core tiene traccia anche delle istanze di Blog.</span><span class="sxs-lookup"><span data-stu-id="7e0d8-135">Here, since we're passing `blog` entities to the client method `StandardizeURL`, EF Core will track the blog instances too.</span></span>

[!code-csharp[Main](../../../samples/core/Querying/Tracking/Sample.cs#ClientProjection)]

[!code-csharp[Main](../../../samples/core/Querying/Tracking/Sample.cs#ClientMethod)]

<span data-ttu-id="7e0d8-136">EF Core non tiene traccia delle istanze di entità senza chiave contenute nel risultato.</span><span class="sxs-lookup"><span data-stu-id="7e0d8-136">EF Core doesn't track the keyless entity instances contained in the result.</span></span> <span data-ttu-id="7e0d8-137">Tuttavia EF Core tiene traccia di tutte le altre istanze dei tipi di entità con chiave in base alle regole precedenti.</span><span class="sxs-lookup"><span data-stu-id="7e0d8-137">But EF Core tracks all the other instances of entity types with key according to rules above.</span></span>

<span data-ttu-id="7e0d8-138">Alcune delle regole precedenti hanno funzionato in modo diverso prima di EF Core 3,0.</span><span class="sxs-lookup"><span data-stu-id="7e0d8-138">Some of the above rules worked differently before EF Core 3.0.</span></span> <span data-ttu-id="7e0d8-139">Per ulteriori informazioni, vedere [versioni precedenti](#previous-versions).</span><span class="sxs-lookup"><span data-stu-id="7e0d8-139">For more information, see [previous versions](#previous-versions).</span></span>

## <a name="previous-versions"></a><span data-ttu-id="7e0d8-140">Versioni precedenti</span><span class="sxs-lookup"><span data-stu-id="7e0d8-140">Previous versions</span></span>

<span data-ttu-id="7e0d8-141">Prima della versione 3,0, EF Core aveva alcune differenze nel modo in cui il rilevamento è stato eseguito.</span><span class="sxs-lookup"><span data-stu-id="7e0d8-141">Before version 3.0, EF Core had some differences in how tracking was done.</span></span> <span data-ttu-id="7e0d8-142">Di seguito sono riportate le differenze rilevanti:</span><span class="sxs-lookup"><span data-stu-id="7e0d8-142">Notable differences are as follows:</span></span>

- <span data-ttu-id="7e0d8-143">Come illustrato nella pagina di [valutazione del client rispetto al server](xref:core/querying/client-eval) , EF core la valutazione client supportata in qualsiasi parte della query prima della versione 3,0.</span><span class="sxs-lookup"><span data-stu-id="7e0d8-143">As explained in [Client vs Server Evaluation](xref:core/querying/client-eval) page, EF Core supported client evaluation in any part of the query before version 3.0.</span></span> <span data-ttu-id="7e0d8-144">La valutazione client ha causato la materializzazione delle entità, che non fanno parte del risultato.</span><span class="sxs-lookup"><span data-stu-id="7e0d8-144">Client evaluation caused materialization of entities, which weren't part of the result.</span></span> <span data-ttu-id="7e0d8-145">Quindi EF Core analizzato il risultato per rilevare gli elementi di cui tenere traccia. Questa progettazione presenta alcune differenze, come indicato di seguito:</span><span class="sxs-lookup"><span data-stu-id="7e0d8-145">So EF Core analyzed the result to detect what to track. This design had certain differences as follows:</span></span>
  - <span data-ttu-id="7e0d8-146">Valutazione client nella proiezione, che ha causato la materializzazione ma non ha restituito l'istanza di entità materializzata non è stata rilevata.</span><span class="sxs-lookup"><span data-stu-id="7e0d8-146">Client evaluation in the projection, which caused materialization but didn't return the materialized entity instance wasn't tracked.</span></span> <span data-ttu-id="7e0d8-147">Nell'esempio seguente non è stata tenuta traccia delle entità `blog`.</span><span class="sxs-lookup"><span data-stu-id="7e0d8-147">The following example didn't track `blog` entities.</span></span>
    [!code-csharp[Main](../../../samples/core/Querying/Tracking/Sample.cs#ClientProjection)]

  - <span data-ttu-id="7e0d8-148">In alcuni casi EF Core non tiene traccia degli oggetti che provengono dalla composizione LINQ.</span><span class="sxs-lookup"><span data-stu-id="7e0d8-148">EF Core didn't track the objects coming out of LINQ composition in certain cases.</span></span> <span data-ttu-id="7e0d8-149">Nell'esempio seguente non è stato rilevato `Post`.</span><span class="sxs-lookup"><span data-stu-id="7e0d8-149">The following example didn't track `Post`.</span></span>
    [!code-csharp[Main](../../../samples/core/Querying/Tracking/Sample.cs#CustomProjection2)]

- <span data-ttu-id="7e0d8-150">Ogni volta che i risultati della query contengono tipi di entità senza chiave, l'intera query è stata eseguita senza rilevamento.</span><span class="sxs-lookup"><span data-stu-id="7e0d8-150">Whenever query results contained keyless entity types, the whole query was made non-tracking.</span></span> <span data-ttu-id="7e0d8-151">Ciò significa che i tipi di entità con chiavi, che non sono presenti nel risultato, non sono stati rilevati.</span><span class="sxs-lookup"><span data-stu-id="7e0d8-151">That means that entity types with keys, which are in result weren't being tracked either.</span></span>
- <span data-ttu-id="7e0d8-152">EF Core ha fatto la risoluzione delle identità in una query senza rilevamento.</span><span class="sxs-lookup"><span data-stu-id="7e0d8-152">EF Core did identity resolution in no-tracking query.</span></span> <span data-ttu-id="7e0d8-153">Sono stati usati riferimenti deboli per tenere traccia delle entità che erano già state restituite.</span><span class="sxs-lookup"><span data-stu-id="7e0d8-153">It used weak references to keep track of entities that had already been returned.</span></span> <span data-ttu-id="7e0d8-154">Quindi, se un set di risultati contiene la stessa entità più volte, si otterrebbe la stessa istanza per ogni occorrenza.</span><span class="sxs-lookup"><span data-stu-id="7e0d8-154">So if a result set contained the same entity multiples times, you would get the same instance for each occurrence.</span></span> <span data-ttu-id="7e0d8-155">Tuttavia, se un risultato precedente con la stessa identità è uscito dall'ambito e viene sottoposta a Garbage Collection, EF Core ha restituito una nuova istanza.</span><span class="sxs-lookup"><span data-stu-id="7e0d8-155">Though if a previous result with the same identity went out of scope and got garbage collected, EF Core returned a new instance.</span></span>
