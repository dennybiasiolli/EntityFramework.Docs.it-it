---
title: Pool DbContext
description: DbContext pooling in Entity Framework Core
author: rick-anderson
ms.author: riande
ms.date: 9/19/2020
uid: core/miscellaneous/context-pooling
ms.openlocfilehash: fd5f53ff97a73895f0c4239439730dd8cb3ecc29
ms.sourcegitcommit: c0e6a00b64c2dcd8acdc0fe6d1b47703405cdf09
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 09/24/2020
ms.locfileid: "91215600"
---
# <a name="dbcontext-pooling"></a><span data-ttu-id="d4a9c-103">Pooling DbContext</span><span class="sxs-lookup"><span data-stu-id="d4a9c-103">DbContext pooling</span></span>

<span data-ttu-id="d4a9c-104">`AddDbContextPool` consente di raggruppare le `DbContext` istanze.</span><span class="sxs-lookup"><span data-stu-id="d4a9c-104">`AddDbContextPool` enables pooling of `DbContext` instances.</span></span> <span data-ttu-id="d4a9c-105">Il pool di contesto può aumentare la velocità effettiva in scenari a scalabilità elevata, ad esempio i server Web riutilizzando le istanze di contesto, anziché creare nuove istanze per ogni richiesta.</span><span class="sxs-lookup"><span data-stu-id="d4a9c-105">Context pooling can increase throughput in high-scale scenarios such as web servers by reusing context instances, rather than creating new instances for each request.</span></span>

<span data-ttu-id="d4a9c-106">Il modello tipico in un'app ASP.NET Core con EF Core prevede la registrazione di un <xref:Microsoft.EntityFrameworkCore.DbContext> tipo personalizzato nel contenitore di [inserimento delle dipendenze](/aspnet/core/fundamentals/dependency-injection) e l'ottenimento di istanze del tipo tramite i parametri del costruttore nei controller o Razor Pages.</span><span class="sxs-lookup"><span data-stu-id="d4a9c-106">The typical pattern in an ASP.NET Core app using EF Core involves registering a custom <xref:Microsoft.EntityFrameworkCore.DbContext> type into the [dependency injection](/aspnet/core/fundamentals/dependency-injection) container and obtaining instances of that type through constructor parameters in controllers or Razor Pages.</span></span> <span data-ttu-id="d4a9c-107">Con l'inserimento del costruttore viene creata una nuova istanza del contesto per ogni richiesta.</span><span class="sxs-lookup"><span data-stu-id="d4a9c-107">Using constructor injection, a new context instance is created for each request.</span></span>

<span data-ttu-id="d4a9c-108"><xref:Microsoft.Extensions.DependencyInjection.EntityFrameworkServiceCollectionExtensions.AddDbContextPool%2A> Abilita un pool di istanze di contesto riutilizzabili.</span><span class="sxs-lookup"><span data-stu-id="d4a9c-108"><xref:Microsoft.Extensions.DependencyInjection.EntityFrameworkServiceCollectionExtensions.AddDbContextPool%2A> enables a pool of reusable context instances.</span></span> <span data-ttu-id="d4a9c-109">Per utilizzare il pool di contesto, utilizzare il `AddDbContextPool` metodo anziché `AddDbContext` durante la registrazione del servizio:</span><span class="sxs-lookup"><span data-stu-id="d4a9c-109">To use context pooling, use the `AddDbContextPool` method instead of `AddDbContext` during service registration:</span></span>

``` csharp
services.AddDbContextPool<BloggingContext>(
    options => options.UseSqlServer(connectionString));
```

<span data-ttu-id="d4a9c-110">Quando `AddDbContextPool` si usa, nel momento in cui viene richiesta un'istanza del contesto, EF verifica innanzitutto se è disponibile un'istanza nel pool.</span><span class="sxs-lookup"><span data-stu-id="d4a9c-110">When `AddDbContextPool` is used, at the time a context instance is requested, EF first checks if there is an instance available in the pool.</span></span> <span data-ttu-id="d4a9c-111">Dopo che l'elaborazione della richiesta è stata finalizzata, lo stato dell'istanza viene reimpostato e quest'ultima viene restituita al pool.</span><span class="sxs-lookup"><span data-stu-id="d4a9c-111">Once the request processing finalizes, any state on the instance is reset and the instance is itself returned to the pool.</span></span>

<span data-ttu-id="d4a9c-112">Questa situazione è concettualmente simile al modo in cui il pool di connessioni opera nei provider ADO.NET e offre il vantaggio di risparmiare parte del costo di inizializzazione dell'istanza del contesto.</span><span class="sxs-lookup"><span data-stu-id="d4a9c-112">This is conceptually similar to how connection pooling operates in ADO.NET providers and has the advantage of saving some of the cost of initialization of the context instance.</span></span>

<span data-ttu-id="d4a9c-113">Il `poolSize` parametro di <xref:Microsoft.Extensions.DependencyInjection.EntityFrameworkServiceCollectionExtensions.AddDbContextPool%2A> imposta il numero massimo di istanze conservate dal pool.</span><span class="sxs-lookup"><span data-stu-id="d4a9c-113">The `poolSize` parameter of <xref:Microsoft.Extensions.DependencyInjection.EntityFrameworkServiceCollectionExtensions.AddDbContextPool%2A> sets the maximum number of instances retained by the pool.</span></span> <span data-ttu-id="d4a9c-114">Una volta `poolSize` superato il limite, le nuove istanze del contesto non vengono memorizzate nella cache e EF esegue il fallback al comportamento non in pool della creazione di istanze su richiesta.</span><span class="sxs-lookup"><span data-stu-id="d4a9c-114">Once `poolSize` is exceeded, new context instances are not cached and  EF falls back to the non-pooling behavior of creating instances on demand.</span></span>

## <a name="limitations"></a><span data-ttu-id="d4a9c-115">Limitazioni</span><span class="sxs-lookup"><span data-stu-id="d4a9c-115">Limitations</span></span>

<span data-ttu-id="d4a9c-116">Le app devono essere profilate e testate per mostrare che l'inizializzazione del contesto è un costo significativo.</span><span class="sxs-lookup"><span data-stu-id="d4a9c-116">Apps should be profiled and tested to show that context initialization is a significant cost.</span></span>

<span data-ttu-id="d4a9c-117">`AddDbContextPool` presenta alcune limitazioni sulle operazioni che possono essere eseguite nel `OnConfiguring` metodo del contesto.</span><span class="sxs-lookup"><span data-stu-id="d4a9c-117">`AddDbContextPool` has a few limitations on what can be done in the `OnConfiguring` method of the context.</span></span>

> [!WARNING]  
> <span data-ttu-id="d4a9c-118">Evitare di usare il pool di contesto nelle app che mantengono lo stato.</span><span class="sxs-lookup"><span data-stu-id="d4a9c-118">Avoid using context pooling in apps that maintain state.</span></span> <span data-ttu-id="d4a9c-119">Ad esempio, i campi privati nel contesto che non devono essere condivisi tra le richieste.</span><span class="sxs-lookup"><span data-stu-id="d4a9c-119">For example, private fields in the context that shouldn't be shared across requests.</span></span> <span data-ttu-id="d4a9c-120">EF Core reimposta solo lo stato di cui è consapevole prima di aggiungere un'istanza del contesto al pool.</span><span class="sxs-lookup"><span data-stu-id="d4a9c-120">EF Core only resets the state that it is aware of before adding a context instance to the pool.</span></span>

<span data-ttu-id="d4a9c-121">Il pool di contesto funziona riutilizzando la stessa istanza del contesto tra le richieste.</span><span class="sxs-lookup"><span data-stu-id="d4a9c-121">Context pooling works by reusing the same context instance across requests.</span></span> <span data-ttu-id="d4a9c-122">Ciò significa che viene registrato in modo efficace come [singleton](/aspnet/core/fundamentals/dependency-injection#service-lifetimes) in termini di istanza stessa, in modo che sia in grado di renderlo persistente.</span><span class="sxs-lookup"><span data-stu-id="d4a9c-122">This means that it's effectively registered as a [Singleton](/aspnet/core/fundamentals/dependency-injection#service-lifetimes) in terms of the instance itself so that it's able to persist.</span></span>

<span data-ttu-id="d4a9c-123">Il pool di contesto è destinato agli scenari in cui la configurazione del contesto, che include servizi risolti, viene fissata tra le richieste.</span><span class="sxs-lookup"><span data-stu-id="d4a9c-123">Context pooling is intended for scenarios where the context configuration, which includes services resolved, is fixed between requests.</span></span> <span data-ttu-id="d4a9c-124">Per i casi in cui i servizi con [ambito](/aspnet/core/fundamentals/dependency-injection#service-lifetimes) sono obbligatori o è necessario modificare la configurazione, non usare il pool.</span><span class="sxs-lookup"><span data-stu-id="d4a9c-124">For cases where [Scoped](/aspnet/core/fundamentals/dependency-injection#service-lifetimes) services are required, or configuration needs to be changed, don't use pooling.</span></span> <span data-ttu-id="d4a9c-125">Il miglioramento delle prestazioni del pool è in genere trascurabile tranne che negli scenari altamente ottimizzati.</span><span class="sxs-lookup"><span data-stu-id="d4a9c-125">The performance gain from pooling is usually negligible except in highly optimized scenarios.</span></span>
